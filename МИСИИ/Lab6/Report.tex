\documentclass[a4paper,14pt]{extarticle}
\usepackage{../../tex-shared/report-layout}

\renewcommand{\mylabnumber}{6}
\renewcommand{\mylabtitle}{Создание динамических баз данных}
\renewcommand{\mysubject}{Методы и средства искусственного интеллекта}
\renewcommand{\mylecturer}{Забаштанский А.К.}

\begin{document}
\input{../../tex-shared/title-page.tex}

\section{Цель работы}
Изучение технологии подготовки и выполнения Пролог-программ в интегрированной
среде, исследование способов организации динамических баз данных (БД) средствами
языка Пролог.

\section{Постановка задачи}
Корректировка данных в базе по году рождения; вывод на дисплей анкетных данных
студентов, получивших одну оценку 3; если таких студентов нет, вывести
соответствующее сообщение.

\begin{table}[H]
    \caption{Таблица по заданию}
    \begin{tabular}{ | c | c | c | c | c | c | c | }
        \hline
        \multirow{2}{*}{Номер}
        & \multirow{2}{*}{Фамилия Имя}
        & \multirow{2}{*}{Год рождения}
        & \multirow{2}{*}{Год поступления}
        & \multicolumn{3}{c |}{Оценки} \\ \cline{5-7} & & & & Ф & ВМ & Пр. \\ \hline
    \end{tabular}
\end{table}

\section{Ход работы}
\subsection{Разработка программы}
Текст программы:
\begin{lstlisting}
:-dynamic студент/7, студент_д/7.
подмножество_людей(ГодПост,R):-
    bagof(студент_д(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3),
            студент(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3), R).
%правило объединения отношений - r1 или r2
%список людей поступивших в 2012 или 2011
объединение_r1_r2(X1,X2,X3,X4,X5,X6,X7):-
    студент_д(X1,X2,X3,'2012',X5,X6,X7),X4='2012';
    студент_д(X1,X2,X3,'2011',X5,X6,X7),X4='2011'.
%формирование списка Rez из фактов "человек_м1_или_м2"
объединение(Rez):-
    bagof(человек_м1_или_м2(X1,X2,X3,X4,X5,X6,X7),
            объединение_r1_r2(X1,X2,X3,X4,X5,X6,X7), %условие вкл. в список
            Rez).
%правило пересечения отношений - r1 или r2
%список людей имена которых похожи и они поступили в 2012 или 2011
пересечение_r1_r2(X11,X12,X13,X14,X15,X16,X17):-
        студент_д(X11,X12,X13,'2012',X15,X16,X17),X14='2012',
        студент_д(X21,X12,X23,'2011',X25,X26,X27),X24='2011'.
%формирование списка Rez из фактов "человек_м1_и_м2"
пересечение(Rez):-
    bagof(человек_м1_и_м2(X11,X12,X13,X14,X15,X16,X17),
        пересечение_r1_r2(X11,X12,X13,X14,X15,X16,X17),
        Rez).
%правило построения разности отношений: r1-r2
%учитываются только люди с совпадающими годами рождения
%список людей имена которых похожи и они  поступили в 2012 но не в 2011
разность_r1_r2(X11,X12,X13,X14,X15,X16,X17):-
    студент_д(X11,X12,X13,'2012',X15,X16,X17),X14='2012',
    not(студент_д(X21,X12,X23,'2011',X25,X26,X27)),X24='2011'.
%построение списка Rez из фактов "человек_м1_и_не_м2"
разность(Rez):-
    bagof(человек_м1_и_не_м2(X11,X12,X13,X14,X15,X16,X17),
            разность_r1_r2(X11,X12,X13,X14,X15,X16,X17), %условие вкл. в список
            Rez).
%добавление термов из списка [H|T] в БД
список_в_бд([]).
список_в_бд([H|T]):-
    H=студент_д(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3),
    assertz(студент_д(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3)),
    список_в_бд(T).     %Рекурсивный вызов для  след. терма
%вывод элементов списка [H|T] в каждой строке
вывод_списка([]).
вывод_списка([H|T]):-write(H),nl,вывод_списка(T).

совпадение(Оц1,Оц2,Оц3,Обр):-Оц1=Обр, !;  Оц2=Обр,!; Оц3=Обр, !.
%первоначальная база, при запуске программы
%студент
%       Номер   Фамилия Имя        Год рождения  Год поступления    Оценки
студент('101', 'Худой Никифор',       '1994',       '2012',     '5', '4', '4').
студент('107', 'Худой Никифор',       '1994',       '2012',     '5', '4', '4').
студент('111', 'Худой Никифор',       '1994',       '2011',     '5', '4', '4').
студент('102', 'Жирный Никифор',      '1997',       '2014',     '5', '5', '5').
студент('103', 'Средний Никифор',     '2000',       '2013',     '5', '3', '5').
студент('104', 'Новый Наракорт',      '1991',       '2011',     '3', '3', '3').

start:-menu.
%0=================Отображение меню===============
menu:-
    repeat,nl,
    repeat, nl,
    write('*******************************'),nl,
    write('* 1. Добавление записи в БД *'),nl,
    write('* 2. Удаление записи из БД *'),nl,
    write('* 3. Поиск троешников *'),nl,
    write('* 4. Просмотр БД *'),nl,
    write('* 5. Загрузка БД из файла *'),nl,
    write('* 6. Сохранение БД в файле *'),nl,
    write('* 7. Реляционные операции *'),nl,
    write('* 8. Корректировка записи по году рождения *'),nl,
    write('* 9. Выход *'),nl,
    write('*******************************'), nl ,nl,
    write('Введите номер пункта меню с точкой в конце!!!'),nl,
    read(C),nl, %Ввод пункта меню
    proc(C), %Запуск процедуры с номером С
    C=9, %Если С не равно 9, то авт. возврат к repeat
    !. %Иначе успешное завершение
%0-----------------------------------------------------------------------------
%1======= добавление записи в базу данных =====================================
proc(1):-
    write('Ввод завершайте точкой!!! :'),nl,
    write('Введите номер:'),nl, read(Номер),
    write('Введите Фамилию и Имя:'),nl, read(ФамИмя),
    write('Введите год рождения:'),nl, read(ГодРожд),
    write('Введите год поступления:'),nl, read(ГодПост),
    write('Введите оценку 1:'),nl, read(Оценка1),
    write('Введите оценку 2:'),nl, read(Оценка2),
    write('Введите оценку 3:'),nl, read(Оценка3),
    assertz(студент(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3)), %добавление факта в БД
    write(ФамИмя),write(' был добавлен в БД'),nl,
    write('Введите любой символ'),nl, %ожидание ввода литеры
    get0(C).
%1-----------------------------------------------------------------------------
%2========= удаление записи из базы данных =================
proc(2):-
    write('Введите Фамилию и Имя для удаления:'), nl,
    read(ФамИмя), %ввод номера сотруд
    retract(студент(_,ФамИмя,_,_,_,_,_)), %удаление записи
    write('Пользователь:'),tab(2),
    write(ФамИмя), tab(2), %вывод сообщения об успешном удалении
    write('был успешно удален из БД'),nl,
    write('Введите любой символ'),nl,
    get0(C), %ожидание ввода символа
    !; %отсечение альтернативы и завершение
    write('Такого пользователя:'),tab(2), %вывод сообщения о безуспешном удалении
    write('в базе данных нет'),nl,
    write('Введите любой символ'),nl,
    get0(C). %ожидание ввода символа
%3================== поиск по оценке =================================
proc(3):-
    write('Наши троешники'),nl,
    retractall(flag(_)), %удаление фактов - flag(_)
    студент(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3), %выбор записи о сотр
    совпадение(Оценка1,Оценка2,Оценка3,'3'), %проверка критерия
    assert(flag(1)), %запомнить флаг – запись
    write(ФамИмя),tab(4), %отображение на дисплее
    nl,
    fail; %возврат для выбора след. записи
    flag(1),write('Введите любой символ...'),nl,get0(C1),!. %eсли записи были найдены, то завершить успе
    proc(3):- %cообщение, если записи не найдены
    write('Троешников нет '),write(ЗнакПоиск),nl,
    write('Введите любой символ'),nl,
    get0(C1),get0(C2).
%4================== просмотр базы данных =================================
proc(4):-
    write('------------------------------------------------------------------------'),nl,
    write('|Номер|    Фамилия и Имя    | Дата рождения | Дата зачисления | Оценки |'),nl,
    write('------------------------------------------------------------------------'),nl,
    студент(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3), %выбор записи о студенте
    write('  '),
    write(Номер),
    write('    '),
    write(ФамИмя),tab(12), %отображение на дисплее
    write(ГодРожд),tab(12), %элементов запаси
    write(ГодПост),tab(12),
    write(Оценка1),
    write(', '),
    write(Оценка2),
    write(', '),
    write(Оценка3),
    nl,
    fail; %возврат к выбору записи
    true,write('Введите любой символ..'),nl,get(C1). %завершение - записей больше нет
%5======== загрузка базы данных из файла ======================================
proc(5):-
    see('F:/student.dat'),  % текущий входной поток
    retractall(студент(_,_,_,_,_,_,_)),%очистка БД от фактов
    db_load, %загрузка БД термами из файла
    seen, %закрытие потока
    write('БД загружена из файла'),nl.
%загрузка термов в БД из открытого вх. потока
db_load:-
    read(Term), %чтение терма
    (Term == end_of_file,!; %если конец файла, то завершение
    assertz(Term), %иначе добавить терм в конец БД
    db_load). %рекурсивный вызов для чтения след. терма
%6========== сохранение БД в файле =========================================
proc(6):-
    tell('F:/student.dat'), %открытие вых. потока
    save_db(студент(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3)), %сохранение терма
    told, %закрытие вых. потока
    write('БД скопирована в файл d:/student.dat'),nl.
%сохранение терма в открытом файле
save_db(Term):- %сохранение терма (факта!) Term в БД
    Term, %отождествление терма с термом в БД
    write(Term), %запись терма
    write('.'),nl, %запись точки в конце терма
    fail; %неудача с целью поиска след. варианта
    true. %завершение, если вариантов отождествления нет
%7============ реализация операций реляционной алгебры ========================
proc(7):-
    nl,
    write('Формирование отношения r1: людей поступивших в 2012 '), nl,
    подмножество_людей('2012',R1),  %R1 - список людей
    список_в_бд(R1),  %добавление элементов из R1 в базу данных
    вывод_списка(R1),nl,  %вывод списка R1 на экран

    write('Формирование отношения r2: людей поступивших в 2011 '), nl,
    подмножество_людей('2011',R2),    %R2 - список людей
    список_в_бд(R2),                  %добавление элементов из R2 в базу данных
    вывод_списка(R2),nl,              %вывод списка R2 на экран

    write('Объединенное отношение r1_или_r2: '),  nl,
    объединение(Rez1),  %Rez1 - список людей поступивших в 2012 или 2011
    вывод_списка(Rez1),nl,

    write('Пересечение отношений r1_и_r2: '),  nl,
    пересечение(Rez2),        %Rez2 - список людей имена которых похожи и они поступили в 2012 или 2011
    вывод_списка(Rez2),nl,

    write('Разность отношений r1-r2: '),  nl,
    разность(Rez3),  %Rez3-список людей имена которых похожи и они  поступили в 2012 но не в 2011
    вывод_списка(Rez3),nl,

    write('Введите любой символ'),nl,
    get0(C).            %Ожидание ввода символа
%------------------------------------------------------------------------------
%формирование подмножества людей R заданного месяцев рождения
%подмножество R представляется в виде списка термов "записная_книжка_д(...)"
%8============ корректировка по году рождения ========================
proc(8):-
    write('Введите год рождения'),nl,
    read(Год),
    retract(студент(_,_,Год,_,_,_,_)), %удаление записи
    write('Ввод завершайте точкой!!! :'),nl,
    write('Введите номер:'),nl, read(Номер),
    write('Введите Фамилию и Имя:'),nl, read(ФамИмя),
    write('Введите год рождения:'),nl, read(ГодРожд),
    write('Введите год поступления:'),nl, read(ГодПост),
    write('Введите оценку 1:'),nl, read(Оценка1),
    write('Введите оценку 2:'),nl, read(Оценка2),
    write('Введите оценку 3:'),nl, read(Оценка3),
    assertz(студент(Номер,ФамИмя,ГодРожд,ГодПост,Оценка1,Оценка2,Оценка3)), %добавление факта в БД
    write('Данные изменены'),
    write('Введите любой символ'),nl,
    get0(C), %ожидание ввода символа
    !; %отсечение альтернативы и завершение
    write('Такого студента '), %вывод сообщения о безуспешном удалении
    write('в базе данных нет'),nl,
    write('Введите любой символ'),nl,
    get0(C). %ожидание ввода символа
%9============выход============================================================
proc(9):-write('Досвидания'),nl.
:- start.
\end{lstlisting}

\subsection{Проверка работы программы}
\begin{lstlisting}
*******************************
* 1. Добавление записи в БД *
* 2. Удаление записи из БД *
* 3. Поиск троешников *
* 4. Просмотр БД *
* 5. Загрузка БД из файла *
* 6. Сохранение БД в файле *
* 7. Реляционные операции *
* 8. Корректировка записи по году рождения *
* 9. Выход *
*******************************

Введите номер пункта меню с точкой в конце!!!
:-3.

Наши троешники
Средний Никифор    
Новый Наракорт    
Введите любой символ...
:-

*******************************
* 1. Добавление записи в БД *
* 2. Удаление записи из БД *
* 3. Поиск троешников *
* 4. Просмотр БД *
* 5. Загрузка БД из файла *
* 6. Сохранение БД в файле *
* 7. Реляционные операции *
* 8. Корректировка записи по году рождения *
* 9. Выход *
*******************************

Введите номер пункта меню с точкой в конце!!!
|4.

------------------------------------------------------------------------
|Номер|    Фамилия и Имя    | Дата рождения | Дата зачисления | Оценки |
------------------------------------------------------------------------
    101    Худой Никифор            1994            2012            5, 4, 4
    107    Худой Никифор            1994            2012            5, 4, 4
    111    Худой Никифор            1994            2011            5, 4, 4
    102    Жирный Никифор            1997            2014            5, 5, 5
    103    Средний Никифор            2000            2013            5, 3, 5
    104    Новый Наракорт            1991            2011            3, 3, 3
Введите любой символ..
:-.

*******************************
* 1. Добавление записи в БД *
* 2. Удаление записи из БД *
* 3. Поиск троешников *
* 4. Просмотр БД *
* 5. Загрузка БД из файла *
* 6. Сохранение БД в файле *
* 7. Реляционные операции *
* 8. Корректировка записи по году рождения *
* 9. Выход *
*******************************

Введите номер пункта меню с точкой в конце!!!
:-7.


Формирование отношения r1: людей поступивших в 2012 
студент_д(101,Худой Никифор,1994,2012,5,4,4)
студент_д(107,Худой Никифор,1994,2012,5,4,4)

Формирование отношения r2: людей поступивших в 2011 
студент_д(111,Худой Никифор,1994,2011,5,4,4)
студент_д(104,Новый Наракорт,1991,2011,3,3,3)

Объединенное отношение r1_или_r2: 
человек_м1_или_м2(101,Худой Никифор,1994,2012,5,4,4)
человек_м1_или_м2(107,Худой Никифор,1994,2012,5,4,4)
человек_м1_или_м2(111,Худой Никифор,1994,2011,5,4,4)
человек_м1_или_м2(104,Новый Наракорт,1991,2011,3,3,3)

Пересечение отношений r1_и_r2: 
человек_м1_и_м2(101,Худой Никифор,1994,2012,5,4,4,111,1994,5,4,4)
человек_м1_и_м2(107,Худой Никифор,1994,2012,5,4,4,111,1994,5,4,4)

Разность отношений r1-r2: 

*******************************
* 1. Добавление записи в БД *
* 2. Удаление записи из БД *
* 3. Поиск троешников *
* 4. Просмотр БД *
* 5. Загрузка БД из файла *
* 6. Сохранение БД в файле *
* 7. Реляционные операции *
* 8. Корректировка записи по году рождения *
* 9. Выход *
*******************************

Введите номер пункта меню с точкой в конце!!!
:-2.

Введите Фамилию и Имя для удаления:
:-'Худой Никифор'.
Пользователь:  Худой Никифор  был успешно удален из БД
Введите любой символ
:-.

*******************************
* 1. Добавление записи в БД *
* 2. Удаление записи из БД *
* 3. Поиск троешников *
* 4. Просмотр БД *
* 5. Загрузка БД из файла *
* 6. Сохранение БД в файле *
* 7. Реляционные операции *
* 8. Корректировка записи по году рождения *
* 9. Выход *
*******************************

Введите номер пункта меню с точкой в конце!!!
:-4.

------------------------------------------------------------------------
|Номер|    Фамилия и Имя    | Дата рождения | Дата зачисления | Оценки |
------------------------------------------------------------------------
    107    Худой Никифор            1994            2012            5, 4, 4
    111    Худой Никифор            1994            2011            5, 4, 4
    102    Жирный Никифор            1997            2014            5, 5, 5
    103    Средний Никифор            2000            2013            5, 3, 5
    104    Новый Наракорт            1991            2011            3, 3, 3
Введите любой символ..
:-
\end{lstlisting}

\section*{Выводы}
В ходе лабораторной работы изучены технологии подготовки и выполнения
Пролог-программ в интегрированной среде, исследованы способы организации
динамических баз данных (БД) средствами языка Пролог.

\end{document}